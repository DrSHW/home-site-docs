---
description: Docs intro
layout: ../../../layouts/MainLayout.astro
---

## 6.6 设备的分配与回收

![image-20221113154236097](https://images.drshw.tech/images/notes/image-20221113154236097.png)

### 6.6.1 设备分配时应考虑的因素

设备的固有属性可分为三种：独占设备、共享设备、虚拟设备：

+ **独占设备**：一个时段只能分配给一个进程（如打印机）；
+ **共享设备**：可同时分配给多个进程使用（如磁盘），各进程往往是宏观上同时使用共享设备，而微观上交替使用；
+ **虚拟设备**：采用SPOOLing技术将独占设备改造成虚拟的共享设备，可同时分配给多个进程使用（如采用SPOOLing技术实现的共享打印机）。

对于设备的分配算法，可使用：先来先服务、优先级高者优先、短任务优先等算法（算法细节不再赘述，类似于[调度算法]()）。

从进程运行的安全性上考虑，设备分配体验两种方式：

+ **安全分配方式**：为进程分配一个设备后就将进程阻塞，本次I/O完成后才将进程唤醒。（考虑进程请求打印机打印输出的例子）

  即一个时间段内每个进程只能使用一个设备。

  优点：破坏了[请求和保持条件](https://docs.drshw.tech/os/3/3/#332-%E6%AD%BB%E9%94%81%E4%BA%A7%E7%94%9F%E7%9A%84%E5%BF%85%E8%A6%81%E6%9D%A1%E4%BB%B6)，不会造成死锁；

  缺点：对于一个进程来说，CPU和I/O设备只能串行工作。

+ 不安全分配方式：进程发出I/O请求后，系统为其分配I/O设备，进程可继续执行，之后还可以发出新的I/O请求。只有某个I/O请求得不到满足时才将进程阻塞。

  即一个进程可以同时使用多个设备。

  优点：进程的计算任务和I/O任务可以并行处理，使进程迅速推进；

  缺点：有可能发生死锁，需要死锁避免处理。

### 6.6.2 设备分配空间结构

#### 设备分配方式

设备分配方式可分为以下两种：

+ 静态分配：进程运行前为其分配全部所需资源，运行结束后归还资源；（破坏了请求与保持条件，不会发生死锁）
+ 动态分配：进程运行过程中动态申请设备资源。

#### 设备分配管理中的数据结构

设备分配管理中需要用到下面几种数据结构：

**设备控制表（DCT）**：系统为每个设备配置一张DCT，用于记录设备情况：

<img src="https://images.drshw.tech/images/notes/image-20221113160555487.png" alt="image-20221113160555487" style="zoom:50%;" />

**控制器控制表（COCT）**：每个设备控制器都会对应一张COCT。操作系统根据COCT的信息对控制器进行操作和管理：  

<img src="https://images.drshw.tech/images/notes/image-20221113160936293.png" alt="image-20221113160936293" style="zoom:50%;" />

**通道控制表（CHCT）**：每个通道都会对应一张CHCT。操作系统根据CHCT的信息对通道进行操作和管理：

<img src="https://images.drshw.tech/images/notes/image-20221113161211278.png" alt="image-20221113161211278" style="zoom:50%;" />

**系统设备表（SDT）**：记录了**系统中全部设备**的情况，每个设备对应一个表目：

<img src="https://images.drshw.tech/images/notes/image-20221113161402377.png" alt="image-20221113161402377" style="zoom:50%;" />

### 6.6.3 设备分配的步骤

#### 传统的设备分配步骤

传统设备分配的步骤如下：

1. 根据进程请求的**物理设备名**查找SDT（注：物理设备名时进程请求分配设备时提供的参数）；

   <img src="https://images.drshw.tech/images/notes/image-20221113161828797.png" alt="image-20221113161828797" style="zoom:50%;" />

2. 根据SDT找到对应的DCT，若**设备**忙碌则将进程PCB挂到**设备等待队列**中，不忙碌则将**设备**分配给进程；

3. 根据DCT（`指向控制表的指针`一项）找到COCT，若**控制器**忙碌则将进程PCB挂到**控制器等待队列**中，不忙碌则将**控制器**分配给进程；

4. 根据COCT（`指向通道表的指针`一项）找到CHCT，若**通道**忙碌则将进程PCB挂到**通道等待队列**中，不忙碌则将**通道**分配给进程。

**只有设备、控制器、通道三者都分配成功时，这次设备分配才算成功，之后便可启动I/O设备进行数据传送**。

缺点：

1. 用户编程时必须使用“物理设备名”，底层细节对用户不透明，不方便编程；
2. 若换了一个物理设备，则程序无法运行；
3. 若进程请求的物理设备正在忙碌，则即使系统中还有同类型的设备，进程也必须阻塞等待。

#### 设备分配步骤的改进

针对传统设备分配方式的缺点，可对第一步和第二步操作进行如下的改进：

1. 根据进程请求的**逻辑设备名**查找SDT（**注：用户编程时提供的逻辑设备名其实就是“设备类型”**）；

2. 查找SDT，找到用户进程**指定类型的、并且空闲**的设备，将其分配给该进程。操作系统**在逻辑设备表（LUT）中新增一个表项**；

   <img src="https://images.drshw.tech/images/notes/image-20221113163759356.png" alt="image-20221113163759356" style="zoom:50%;" />

后两步与传统分配步骤相同。

**逻辑设备表（LUT）建立了逻辑设备名与物理设备名之间的映射关系**。

某用户进程第一次使用设备时使用逻辑设备名向操作系统发出请求，操作系统根据用户进程指定的设备类型（逻辑设备名）查找系统设备表，找到一个空闲设备分配给进程，并在LUT中增加相应表项。

**如果之后用户进程再次通过相同的逻辑设备名请求使用设备，则操作系统通过LUT表即可知道用户进程实际要使用的是哪个物理设备了，并且也能知道该设备的驱动程序入口地址**。

逻辑设备表的设置问题：

+ 整个系统只有一张LUT：各用户所用的**逻辑设备名不允许重复**，适用于单用户操作系统；
+ 每个用户一张LUT：**不同用户的逻辑设备名可重复**，适用于多用户的操作系统。
