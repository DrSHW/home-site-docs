---
description: Docs intro
layout: ../../../layouts/MainLayout.astro
---

## 6.7 缓冲区管理

<img src="https://images.drshw.tech/images/notes/image-20221113164753571.png" alt="image-20221113164753571" style="zoom:50%;" />

### 6.7.1 缓冲区的概念

缓冲区是一个存储区域，可以由专门的硬件寄存器组成，也可以利用内存作为缓冲区。

使用**硬件作为缓冲区**的**成本较高**，**容量也较小**，一般仅用在对速度要求非常高的场合（如存储器管理中所用的联想寄存器，由于对页表的访问频率极高，因此使用速度很快的联想寄存器来存放页表项的副本）。

一般情况下，更多的是利用**内存作为缓冲区**，“设备独立性软件”的缓冲区管理就是要组织管理好这些缓冲区。

缓冲区的作用：

+ 缓和CPU与I/O设备之间速度不匹配的矛盾：

  <img src="https://images.drshw.tech/images/notes/image-20221113170043981.png" alt="image-20221113170043981" style="zoom:50%;" />

+ 减少对CPU的中断频率，放宽对CPU中断时间的限制：

  <img src="https://images.drshw.tech/images/notes/image-20221113170128017.png" alt="image-20221113170128017" style="zoom:50%;" />

+ 解决数据粒度不匹配的问题：

  如：输出进程每次可以生成一块数据，但I/O设备每次只能输出一个字符。

+ 提高CPU与I/O设备的并行性。

### 6.7.2 缓冲策略

缓冲策略可分为单缓冲策略和双缓冲策略：

#### 单缓冲策略

假设某用户进程请求某种块设备读入若干块的数据。若采用**单缓冲**的策略，操作系统会**在主存中为其分配一个缓冲区**（若题目中没有特别说明，一个缓冲区的大小就是一个块）。

注意：**当缓冲区数据非空时，不能往缓冲区充入数据，只能从缓冲区将数据传出；当缓冲区为空时，可以往缓冲区冲入数据，但必须把缓冲区充满以后，才能从缓冲区把数据传出**。

<img src="https://images.drshw.tech/images/notes/image-20221113170939946.png" alt="image-20221113170939946" style="zoom:50%;" />

> 应试策略：计算每处理一块数据平均需要多久？
>
> 技巧：假定一个初始状态，分析下次到达相同状态需要多少时间，这就是处理一块数据平均所需时间。
>
> 在“单缓冲”题型中，可以假设初始状态为**工作区满，缓冲区空**：
>
> 当`T(输入时间) > C(处理时间)`时，CPU处理完数据后暂时不能将下一块数据传送到工作区，必须等待缓冲区中充满数据：
>
> <img src="https://images.drshw.tech/images/notes/image-20221113171644831.png" alt="image-20221113171644831" style="zoom:50%;" />
>
> 当`T < C`时，缓冲区中充满数据后暂时不能继续充入下一块数据，必须等待CPU处理结束后将数据从缓冲区传送到工作区：
>
> <img src="https://images.drshw.tech/images/notes/image-20221113172222289.png" alt="image-20221113172222289" style="zoom:50%;" />
>
> 得出结论：**采用单缓冲策略，处理一块数据平均耗时`Max(C, T) + M`**。

#### 双缓冲策略

假设某用户进程请求某种块设备读入若干块的数据，若采用**双缓冲**的策略，操作系统会**在主存中为其分配两个缓冲区**（若题目中没有特殊说明，一个缓冲区的大小就是一个块）。

<img src="https://images.drshw.tech/images/notes/image-20221113172644541.png" alt="image-20221113172644541" style="zoom:50%;" />



> 应试策略：计算每处理一块数据平均需要多久？
>
> 在“双缓冲”题型中，可以假设初始状态为**工作区空，其中一个缓冲区满，另一个缓冲区空**：
>
> 当`T(输入时间) > C(处理时间) + M(传送时间)`时，处理一块数据的平均用时为`T`：
>
> <img src="https://images.drshw.tech/images/notes/image-20221113173020829.png" alt="image-20221113173020829" style="zoom:50%;" />
>
> 当`T < C + M `时：
>
> <img src="https://images.drshw.tech/images/notes/image-20221113173355598.png" alt="image-20221113173355598" style="zoom:50%;" />
>
> 注：`M(1)`表示“将缓冲区1中的数据传送到工作区”；`M(2)`表示“将缓冲区2中的数据传送到工作区”。
>
> 得出结论：**采用双缓冲策略，处理一块数据平均耗时`Max(T, C + M)`**。

#### 使用单/双缓冲在通信时的区别

两台机器之间通信时，可以配置缓冲区用于数据的发送和接收：

由于缓冲区的特性（未充满时不可取，未取空时不可充），若两个相互通信的机器只设置单缓冲区，在任一时刻只能实现数据的单向传输：

<img src="https://images.drshw.tech/images/notes/image-20221113173805802.png" alt="image-20221113173805802" style="zoom:50%;" />

若两个相互通信的机器设置双缓冲区，则同一时刻可以实现双向的数据传输：

<img src="https://images.drshw.tech/images/notes/image-20221113174346399.png" alt="image-20221113174346399" style="zoom:50%;" />

注：[管道通信](https://docs.drshw.tech/os/2/6/#252-%E7%AE%A1%E9%81%93%E9%80%9A%E4%BF%A1)中的“管道”其实就是缓冲区。**要实现数据的双向传输，必须设置两个管道**。

### 6.7.3 循环缓冲区

循环缓冲区即将多个**大小相等**的缓冲区链接成一个**循环队列**，并引入`in`指针与`out`指针管理缓冲区：

<img src="https://images.drshw.tech/images/notes/image-20221113174549854.png" alt="image-20221113174549854" style="zoom:50%;" />

注：上图中，橙色表示已充满数据的缓冲区，绿色表示空缓冲区。

### 6.7.4 缓冲池

**缓冲池**由系统共用的缓冲区组成。这些缓冲区按使用状况可以分为：空缓冲队列，装满输入数据的缓冲队列（输入队列）、装满输出数据的缓冲队列（输出队列）：

<img src="https://images.drshw.tech/images/notes/image-20221113175200320.png" alt="image-20221113175200320" style="zoom:50%;" />

另外，根据一个缓冲区在实际运算中扮演的功能不同，又设置了四种工作缓冲区：用于收容输入数据的工作缓冲区（hin）、用于提取输入数据的工作缓冲区（sin）、用于收容输出数据的工作缓冲区（hout）、用于提取输出数据的工作缓冲区（sout）：

<img src="https://images.drshw.tech/images/notes/image-20221113175236627.png" alt="image-20221113175236627" style="zoom:50%;" />

缓冲池一些操作的处理：

+ 若输入进程请求输入数据：

  系统将从空缓冲队列中取出一块作为收容输入数据的工作缓冲区（hin）。冲满数据后将缓冲区挂到输入队列队尾。

+ 若计算进程想要取得一块输入数据：

  系统将从输入队列中取得一块充满输入数据的缓冲区作为“提取输入数据的工作缓冲区（sin）”。缓冲区读空后挂到空缓冲区队列。

+ 若计算进程想要将准备好的数据充入缓冲区：

  系统将从空缓冲队列中取出一块作为“收容输出数据的工作缓冲区（hout）”。数据充满后将缓冲区挂到输出队列队尾。

+ 若输出进程请求输出数据：

  系统将从输出队列中取得一块充满数据的缓冲区作为“提取输出数据的工作缓冲区（sout）”。缓冲区读空后挂到空缓冲区队列。

