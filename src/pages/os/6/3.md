---
description: Docs intro
layout: ../../../layouts/MainLayout.astro
---

## 6.3 I/O控制方式

I/O控制方式有以下四种：

<img src="https://images.drshw.tech/images/notes/image-20221112164719515.png" alt="image-20221112164719515" style="zoom:50%;" />

需要注意的问题：

1. 完成一次读/写操作的流程；
2. CPU干预的频率；
3. 数据传送的单位；
4. 数据的流向；
5. 主要的优点/缺点。

### 6.3.1 程序直接控制方式

完成一次读/写操作的流程（以**读操作**为例）：

1. CPU向控制器发出读指令：

   此时设备启动，并将状态寄存器设为1；

2. **轮询**检查控制器的状态：

   其实就是在不断地执行程序的循环，若状态位一直是1，说明设备还没准备好要输入的数据，于是CPU会不断地轮询；

3. 输入设备准备好数据后将数据传给控制器，并报告自身状态；

4. 控制器将输入的数据放到数据寄存器中，并将状态改为0（已就绪）；

5. CPU发现设备已就绪，即可将数据寄存器中的内容读入CPU的寄存器中，再把CPU寄存器中的内容放入内存；

6. 若还要继续读入数据，则CPU继续发出读指令。

![image-20221112170418901](https://images.drshw.tech/images/notes/image-20221112170418901.png)

总体流程：

<img src="https://images.drshw.tech/images/notes/image-20221112172046039.png" alt="image-20221112172046039" style="zoom:50%;" />

> 解释：
>
> ① CPU向控制器发出命令；
>
> ② 将I/O状态信息读入CPU寄存器；
>
> ③ 设备可能出现错误；
>
> ④ 将数据寄存器中的内容读入CPU寄存器；
>
> ⑤ 将CPU寄存器中的内容写到内存中。

CPU干预的频率：很频繁，I/O操作开始之前、完成之后需要CPU介入，并且**在等待I/O完成的过程中CPU需要不断地轮询检查**。

数据传送的单位：每次读/写**一个字**。

数据的流向：

+ 读操作（数据输入）：I/O设备 → CPU（寄存器） → 内存；
+ 写操作（数据输出）：内存 → CPU → I/O设备；
+ 每个字的读/写都需要CPU的帮助；

主要优缺点：

+ 优点：实现简单。在读/写指令后加上实现循环检查的一系列指令即可（因此才称为“程序直接控制方式”）；
+ 缺点：**CPU和I/O设备只能串行工作，CPU需要一直轮询检查，长期处于“忙等”状态**，CPU利用率低。

### 6.3.2 中断驱动方式

引入**中断机制**。由于I/O设备速度很慢，因此在CPU发出读/写命令后，可**将等待I/O的进程阻塞**，先切换到别的进程执行。

当I/O完成后，控制器会向CPU发出一个中断信号，CPU**检测到中断信号后**，会保存当前进程的运行环境信息，转去执行中断处理程序处理该中断。

处理中断的过程中，CPU从I/O控制器读一个字的数据传送到CPU寄存器，再写入主存。接着，**CPU恢复等待I/O的进程（或其他进程）的运行环境，然后继续执行**。

注意： 

1. CPU会在每个指令周期的末尾检查中断；
2. 中断处理过程中需要保存、恢复进程的运行环境，这个过程是需要一定时间开销的。可见，如果中断发生的频率太高，也会降低系统性能。

总体流程：

<img src="https://images.drshw.tech/images/notes/image-20221112173525300.png" alt="image-20221112173525300" style="zoom:50%;" />

CPU干预的频率：每次I/O操作开始之前、完成之后需要CPU介入；**等待I/O完成的过程中CPU可以切换到别的进程执行**。

数据传送的单位：每次读/写**一个字**。

数据的流向：

+ 读操作（数据输入）：I/O设备 → CPU → 内存；
+ 写操作（数据输出）：内存 → CPU → I/O设备；
+ 每个字的读/写都需要CPU的帮助；

主要优缺点：

+ 优点：与“程序直接控制方式”相比，在“中断驱动方式”中，I/O控制器会通过中断信号主动报告I/O已完成，CPU不再需要不停地轮询；**CPU和I/O设备可并行工作**，CPU利用率得到明显提升；
+ 缺点：每个字在I/O设备与内存之间的传输，都需要经过CPU；而**频繁的中断处理会消耗较多的CPU时间**。

### 6.3.3 DMA 方式

与“中断驱动方式”相比，DMA（Direct Memory Access，直接存储器存取）方式有这样几个改进：

1. **数据的传送单位是“块”**，而不再以单个字的形式传送；
2. 数据的流向是从设备直接放入内存，或者从内存直接到设备，不再需要CPU作为中转媒介；
3. 仅在传送一个或多个数据块的开始和结束时，才需要CPU干预。

总体流程：

<img src="https://images.drshw.tech/images/notes/image-20221112174655050.png" alt="image-20221112174655050" style="zoom:50%;" />

> 解释：
>
> ① CPU指明此次要进行的操作（如：读操作），并说明要读入多少数据、数据要存放在内存的什么位置、数据在外部设备上的地址（如：在磁盘上的地址）；
>
> ② 控制器会根据CPU提出的要求完成数据的读/写工作，整块数据传输完成后，才向CPU发出中断信号。

**DMA控制器**由：主机——控制器接口、I/O控制逻辑、块设备——控制器接口三部分组成，对应I/O控制器的三个部分。

DMA控制器整体运作流程：

<img src="https://images.drshw.tech/images/notes/image-20221112175540820.png" alt="image-20221112175540820" style="zoom:50%;" />

> DR（Data Register，数据寄存器）：暂存从设备到内存，或从内存到设备的数据；
>
> MAR（Memory Address Register，内存地址寄存器）：在输入时，MAR 表示数据应放到内存中的什么位置；
>
> DC（Data Counter，数据计数器）：表示剩余要读/写的字节数；
>
> CR（Command Register，命令/状态寄存器）：用于存放CPU发来的I/O命令，或设备的状态信息。

CPU干预的频率：仅在传送一个或多个数据块的开始和结束时，才需要CPU干预。

数据传送的单位：每次读/写**一个或多个块**（**注意：每次读写的只能是连续多个块，且这些块读入内存后在内存中也必须是连续的**）。

数据的流向（**无需经过CPU**）：

+ 读操作（数据输入）：I/O设备 → 内存；
+ 写操作（数据输出）：内存 → I/O设备；
+ 每个字的读/写都需要CPU的帮助；

主要优缺点：

+ 优点：数据传输以“块”为单位，CPU介入效率进一步降低。数据的传输不再需要先经过CPU再写入内存，数据传输效率进一步增加；CPU和I/O设备的并行性得到提升；
+ 缺点：CPU每发出一条I/O指令，只能读/写一个或多个连续的数据块；如果要读/写多个离散存储的数据块，或者要将数据分别写到不同的内存区域时，CPU要分别发出多条I/O指令，进行多次中断处理才能完成。

### 6.3.4 通道控制方式

这里的**通道**指的是一种**硬件**，可以理解为一个“**弱化版的CPU**”。通道可以识别并执行一系列**通道指令**。

> 与CPU相比，通道可以执行的指令很单一，并且通道程序是存放在主机内存中的，也就是说通道与CPU共享内存。

通道的工作原理：

<img src="https://images.drshw.tech/images/notes/image-20221112181306602.png" alt="image-20221112181306602" style="zoom:50%;" />

“设备、控制器、通道”之间的关系：

<img src="https://images.drshw.tech/images/notes/image-20221113160139801.png" alt="image-20221113160139801" style="zoom:50%;" />

一个通道可控制多个设备控制器，每个设备控制器可控制多个设备（树形结构）。

通道控制方式总体流程：

<img src="https://images.drshw.tech/images/notes/image-20221112181339834.png" alt="image-20221112181339834" style="zoom:50%;" />

CPU干预的频率：极低，通道会根据CPU的指示执行相应的通道程序，只有一组数据块的读/写后才需要发出中断信号，请求CPU干预。

数据传送的单位：每次读/写**一组数据块**。

数据的流向（**在通道控制下进行**）：

+ 读操作（数据输入）：I/O设备 → 内存；
+ 写操作（数据输出）：内存 → I/O设备；

主要优缺点：

+ 优点：**CPU、通道、I/O设备可并行工作，资源利用率很高**；
+ 缺点：实现复杂，需要专门的通道硬件支持。