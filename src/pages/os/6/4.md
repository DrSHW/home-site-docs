---
description: Docs intro
layout: ../../../layouts/MainLayout.astro
---

## 6.4 I/O软件层次结构

I/O软件的层次从上至下可以分为：用户层软件、设备独立性软件、设备驱动程序、中断处理程序、硬件，其中：

+ 设备独立性软件、设备驱动程序、中断处理程序属于操作系统的内核部分，即“I/O系统”或称“I/O”核心子系统；
+ 硬件由[机械部件和电子部件](https://docs.drshw.tech/os/6/2/#621-io%E8%AE%BE%E5%A4%87%E7%9A%84%E9%83%A8%E4%BB%B6)组成。

<img src="https://images.drshw.tech/images/notes/image-20221112220827449.png" alt="image-20221112220827449" style="zoom:50%;" />

其中的每一层都会利用其下层提供的服务，实现某些功能，并屏蔽实现的具体细节，向高层提供服务（“封装思想”，类似于计算机网络中的“层”）。

### 6.4.1 用户层软件

用户层（又名系统调用处理层）软件**实现了与用户交互的接口**，用户可直接使用该层提供的、与I/O操作相关的库函数，例如：`printf("Hello World!");`即调用了库函数`printf`来实现打印。

用户层软件将用户请求翻译成格式化的I/O请求，并通过“系统调用”请求操作系统内核的服务。例如：`printf("Hello World!");`会被翻译成等价的`write`系统调用。当然，用户层软件也会在系统调用时填入相应参数。

<img src="https://images.drshw.tech/images/notes/image-20221112221742452.png" alt="image-20221112221742452" style="zoom:50%;" />

Windows操作系统向外提供的一系列系统调用，但是由于系统调用的格式严格，使用麻烦，因此在用户层上封装了更方便的库函数接口共用户使用（Windows API）。

### 6.4.2 设备独立性软件

**设备独立性**（又称为**设备无关性**）软件几乎实现了全部的，与设备硬件特性无关的功能。

主要实现的功能如下：

1. 向上提供统一的接口（如`read/write`系统调用）；

2. 设备的保护：

   原理类似于文件保护。设备被看作是一种特殊的文件，不同用户对各个文件的访问权限是不一样的。同理，对设备的访问权限也不一样；

3. 差错处理：

   设备独立性软件需要对一些设备的错误进行处理；

4. 设备的分配与回收：

   在[设备的分配与回收](https://docs.drshw.tech/os/6/6/)一节中，将详细讲解；

5. 数据缓冲区管理：

   可以通过技术屏蔽设备之间数据交换单位大小和传输速度的差异，在[缓冲区管理](https://docs.drshw.tech/os/6/7/)一节中详细讲解；

6. 建立逻辑设备名到物理设备名的映射关系：

   即根据设备类型选择调用相应的驱动程序。

   用户或用户层软件发出I/O操作相关的系统调用时，需要指明此次要操作的I/O设备的逻辑设备名（例如：打印店中，需要选择`打印机1`/`打印机2`/`打印机3`——它们都是**逻辑设备名**）。

   设备独立性软件需要通过“**（LUT，Logical Unit Table）**”来确定逻辑设备对应的**物理设备**，并找到该设备对应的**设备驱动程序**，LUT示例：

   <img src="https://images.drshw.tech/images/notes/image-20221112224742133.png" alt="image-20221112224742133" style="zoom:50%;" />

   操作系统可以采用两种方式管理**逻辑设备表（LUT）**：

   + 第一种方式：**整个系统只设置一张LUT**，这就意味着所有用户不能使用相同的逻辑设备名，因此这种方式只适用于单用户操作系统；
   + 第二种方式：**为每个用户设置一张LUT**，各个用户使用的逻辑设备名可以重复，适用于多用户操作系统。系统会在用户登录时为其建立一个用户管理进程，而LUT就存放在用户管理进程的PCB中。

   （类似于单级目录和两级目录的区别）

### 6.4.3 设备驱动程序

设备驱动程序主要负责对硬件设备的具体控制，将上层发出的一系列命令（如`read`/`write`）转化成特定设备“能听得懂”的一系列操作。包括设置设备寄存器；检查设备状态等。

在逻辑设备表中可见，不同设备的驱动程序的入口地址不一定相同，即不同的设备需要不同的设备驱动程序。这是因为不同设备的内部硬件特性不同，这些特性只有厂家才知道，因此厂家须提供与设备相对应的驱动程序，CPU执行驱动程序的指令序列，来完成设备寄存器，检查设备状态等工作。

注：驱动程序一般会以一个**独立进程**的方式存在。

### 6.4.4 中断处理程序

当I/O任务完成时，I/O控制器会发送一个**中断信号**，系统会**根据中断信号类型**找到相应的**中断处理程序**并执行。中断处理程序的处理流程如下：

<img src="https://images.drshw.tech/images/notes/image-20221112231012297.png" alt="image-20221112231012297" style="zoom:50%;" />

除了设备驱动程序，中断处理程序也需要直接和硬件打交道。

### 6.4.5 I/O核心子系统

I/O层次结构的总结：

<img src="https://images.drshw.tech/images/notes/image-20221112231301124.png" alt="image-20221112231301124" style="zoom:50%;" />

**直接涉及到硬件具体细节、且与中断无关的操作肯定是在设备驱动程序层完成的；没有涉及硬件的、对各种设备都需要进行的管理工作都是在设备独立性软件层完成的**。

I/O核心子系统需要提供I/O调度、设备保护、假脱机技术、设备分配与回收、缓冲区管理等功能。

注：假脱机技术（SPOOLing技术）需要请求“磁盘设备”的设备独立性软件的服务，在[假脱机技术](https://docs.drshw.tech/os/6/5/)一节详细讲解。因此一般来说，假脱机技术是在**用户层**实现的。但是408大纲又将假脱机技术归为“I/O核心子系统”的功能，因此考试时还是以大纲为准。

在本节中我们介绍I/O调度和设备保护两大功能：

#### I/O 调度

I/O 调度即**用某种算法确定一个好的顺序来处理各个I/O请求**，如：

+ [磁盘调度](https://docs.drshw.tech/os/8/3/#833-%E5%85%88%E6%9D%A5%E5%85%88%E6%9C%8D%E5%8A%A1%E7%AE%97%E6%B3%95fcfs)。当需要处理当多个磁盘I/O请求到来时，用某种磁盘调度算法满足I/O请求的顺序；
+ 打印机等设备也可以采用[进程调度算法](https://docs.drshw.tech/os/3/2/)处理I/O的调度顺序。

#### 设备保护

操作系统需要实现[文件保护](https://docs.drshw.tech/os/7/6/)功能，不同的用户对各个文件有不同的访问权限（如：只读、读和写等）。

在UNIX操作系统中，设备被看做是一种特殊的文件，每个设备也会有对应的[FCB](https://docs.drshw.tech/os/7/3/#%E6%96%87%E4%BB%B6%E6%8E%A7%E5%88%B6%E5%9D%97)。当用户请求访问某个设备时，系统会根据FCB记录的信息来判断该用户是否有相应的访问权限，以此实现“设备保护的功能”。

