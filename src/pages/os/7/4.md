---
description: Docs intro
layout: ../../../layouts/MainLayout.astro
---

 ## 7.4 文件的基本操作

在7.1中，我们了解了[操作系统需要向上提供的六种功能](https://docs.drshw.tech/os/7/1/#714-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%89%80%E9%9C%80%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8)，在本节中我们探讨这些功能背后的具体过程。

<img src="https://images.drshw.tech/images/notes/image-20221105134147288.png" alt="image-20221105134147288" style="zoom: 28%;" />

### 7.4.1 创建文件

创建文件即执行“**create 系统调用**”。

进行create 系统调用时，需要提供的几个主要参数：

1. 所需的外存空间大小（如：一个盘块，1KB）；
2. 文件存放路径（如：`D:/Files`）；
3. 文件名（如`打印机.txt`）。

操作系统在处理create 系统调用时，主要做了两件事：

1. **在外存中找到文件所需的空间**；
2. 根据文件存放路径的信息找到该目录对应的目录文件，在目录中**创建该文件对应的目录项**。目录项中包含了文件名、文件在外存的存放位置等信息。

### 7.4.2 删除文件

删除文件即执行“**delete 系统调用**”。

进行delete 系统调用时，需要提供的几个主要参数：

1. 文件存放路径；
2. 文件名。

操作系统在处理delete 系统调用时，主要做了几件事：

1. 根据文件存放路径找到相应的目录文件，从目录中**找到文件名对应的目录项**；
2. 根据该目录项记录的文件在外存中的位置、文件大小等信息，**回收文件占用的磁盘块**；
3. 从目录表中**删除文件对应的目录项**。

### 7.4.3 打开文件

在很多操作系统中，在对文件进行操作之前，要求用户先使用**open 系统调用**“打开文件”，需要提供的几个主要参数：

1. 文件存放路径；
2. 文件名；
3. 要对文件的操作类型（如：`r`只读，`rw`可读写等）。

操作系统在处理open 系统调用时，主要做了几件事：

1. 根据文件存放路径找到相应的目录文件，从目录中**找到文件名对应的目录项**，并检查该用户是否拥有指定的操作权限；
2. **将目录项复制到内存的打开文件表中**，并将对应表目的编号返回给用户。之后用户使用打开文件表的**编号**来指明要操作的文件（**不需要每次都重新查目录了**，加快文件访问速度）。

<img src="https://images.drshw.tech/images/notes/image-20221105141449559.png" alt="image-20221105141449559" style="zoom:25%;" />

操作系统中有两种打开文件表，即系统进程的打开文件表和用户进程的打开文件表，结构如下：

<img src="https://images.drshw.tech/images/notes/image-20221105142146730.png" alt="image-20221105142146730" style="zoom:25%;" />

特殊字段说明：

+ **打开计数器**：记录此时有多少个进程打开了此文件；
+ **读写指针**：记录了该进程对文件的读/写操作进行到的位置；

若**访问权限**冲突（如用户请求在只读的文件中进行写操作），会被操作系统视为非法操作，拒绝访问。

### 7.4.4 关闭文件

进程使用完文件后，要“关闭文件”，即执行“**close 系统调用**”。

操作系统在处理close 系统调用时，主要做了几件事：

1. 将进程的打开文件表相应表项删除；
2. 回收分配给该文件的内存空间等资源；
3. 系统打开文件表的打开计数器`count`值减1，若`count == 0`，则删除对应表项。

### 7.4.5 读文件

读文件需要执行“**read 系统调用**”。

进行read 系统调用时，需要提供的几个主要参数：

1. 文件名（在支持“打开文件”操作的系统中，只需要提供文件在打开文件表中的**索引号**即可）；
2. 读入数据所需空间大小；
3. 读入数据在内存中存放的位置。

操作系统在处理read 系统调用时，会从读指针指向的外存中，将用户指定大小的数据读入用户指定的内存区域中。

### 7.4.6 写文件

写文件需要执行“**write 系统调用**”。

进行write 系统调用时，需要提供的几个主要参数：

1. 文件名（在支持“打开文件”操作的系统中，只需要提供文件在打开文件表中的**索引号**即可）；
2. 写出数据所需空间大小；
3. 写回外存的数据在内存中存放的位置。

操作系统在处理write 系统调用时，会从用户指定的内存区域中，将指定大小的数据写回写指针指向的外存。

