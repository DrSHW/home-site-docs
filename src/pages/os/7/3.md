---
description: Docs intro
layout: ../../../layouts/MainLayout.astro
---

 ## 7.3 文件目录

文件目录类似于Windows操作系统的文件夹。它使文件之间的组织结构清晰，用户易于查找；且用户可以轻松实现“按名存取”。

<img src="https://images.drshw.tech/images/notes/image-20221104163734621.png" alt="image-20221104163734621" style="zoom: 28%;" />

### 7.3.1 文件目录的实现

#### 文件控制块

目录本身是一种有结构文件，由一条条记录组成。每条记录对应一个放在该目录下的文件。

<img src="https://images.drshw.tech/images/notes/image-20221104170152026.png" alt="image-20221104170152026" style="zoom: 67%;" />

例如，当我们进入`Files`目录时，操作系统会在这个目录表中找到关键字`Files`对应的目录项（也就是记录），然后从外存中将`Files`目录信息读入内存。于是，`Files`目录中的内容就可以显示出来了，上方的目录中的文件信息可对应下表：

| 文件名  | 类型        | 存取权限 | ...... | 物理位置    |
| ------- | ----------- | -------- | ------ | ----------- |
| `1.txt` | TXT文本文件 | 只读     | ...    | 外存25号块  |
| `2.txt` | TXT文本文件 | 读/写    | ...    | 外存114号块 |
| `3.txt` | TXT文本文件 | 读/写    | ...    | 外存514号块 |
| `os`    | 目录        | 只读     | ...    | 外存995号块 |

目录文件中的一条记录，就是一个“**文件控制块（FCB）**”。

FCB的有序集合称为“文件目录”，一个FCB就是一个文件**目录项**。FCB中包含了文件的**基本信息**（**文件名**、**物理地址**、逻辑结构、物理结构等），存取控制信息（是否可读/可写、禁止访问的用户名单等），使用信息（如文件的建立时间、修改时间等）。

由于FCB中包含了文件名和文件存放的物理地址，FCB实现了文件名和文件之间的映射，使用户（用户程序）可以实现“**按名存取**”。

#### 对文件目录的操作

需要对文件目录进行下面几种操作：

+ **搜索**：当用户需要使用一个文件时，系统要根据文件名搜索目录，找到该文件对应的目录项；
+ **创建文件**：创建一个新文件时，需要在其所属的目录中增加一个目录项；
+ **删除文件**：当删除一个文件时，需要在目录中删除相应的目录项；
+ **显示目录**：用户可以请求显示目录的内容，如显示目录中的所有文件及相应属性；
+ **修改目录**：某些文件属性保存在目录中，因此这些属性变化时需要修改相应的目录项（如：文件重命名）。

### 7.3.2 目录结构

#### 单级目录结构

早期操作系统并不支持多级目录，整个系统中只建立一张目录表，每个文件占一个目录项:

<img src="https://images.drshw.tech/images/notes/image-20221104171934818.png" alt="image-20221104171934818" style="zoom:25%;" />

单级目录实现了“按名存取”，但是**不允许文件重名**。

在创建一个文件时，需要先检查目录表中有没有重名文件，确定不重名后才能允许建立文件，并将新文件对应的目录插入目录表中。

显然，单级目录结构不适用于多用户操作系统。

#### 两级目录结构

早期的多文件系统，采用两级目录结构。分为**主文件目录**（MFD，Master File Directory）和**用户文件目录**（UFD，User File Directory）:

<img src="https://images.drshw.tech/images/notes/image-20221104172338494.png" alt="image-20221104172338494" style="zoom:25%;" />

这种文件目录结构**允许不同的用户的文件重名**（文件名虽然相同，但是对应的其实是不同的文件），也可以在目录上实现访问限制（检查此时登录的用户名是否匹配）。

但是两级目录结构依然缺乏灵活性，用户不能对自己的文件进行分类。

#### 多级目录结构

又称**树形文件目录**，用户（或用户进程）要访问某个文件时要用文件路径名标识文件，文件路径名是个字符串。各级目录之间使用`/`隔开。**从根目录出发**的路径称为**绝对路径**：

<img src="https://images.drshw.tech/images/notes/image-20221104173046266.png" alt="image-20221104173046266" style="zoom:25%;" />

例如：上图中`自拍.jpg`的绝对路径是`/照片/2015-08/自拍.jpg`。

系统根据绝对路径一层一层地找到下一级目录。以上图为例，刚开始**从外存读入根目录的目录表**；找到`照片`目录的存放位置后，**从外存读入对应的目录表**；再找到`2015-08`目录的存放位置，再**从外存读入对应目录表**；最后才找到文件`自拍.jpg`的存放位置。整个过程**需要3次读磁盘I/O操作**。

很多时候，用户会连续访问同一目录内的多个文件（比如：接连查看`2015-08`目录内的多个照片文件）。显然，每次都从根目录开始查找是很低效的。因此可以设置一个“**当前目录**”。

例如，此时已经打开了`照片`的目录文件，也就是说，这张目录表已调入内存，那么可以把它设置为“当前目录”。当用户想要访问某个文件时，可以使用**从当前目录**出发的“**相对路径**”。

例如：在Linux操作系统中，`.`表示当前目录，因此如果`照片`是当前目录，则`自拍.jpg`的相对路径为：`./2015-08/自拍.jpg`。

**树形目录结构**可以很方便地对文件进行分类，层次结构清晰，也能够更有效地进行文件的管理和保护。但是，树形结构不便**于实现文件的共享**。为此，提出了“**无环图目录结构**”。

#### 无环图目录结构

在树形目录结构的基础上，增加一些指向同一节点的有向边，使整个目录成为一个**有向无环图**。可以更方便地实现多个用户间的数据共享。

<img src="https://images.drshw.tech/images/notes/image-20221104193024226.png" alt="image-20221104193024226" style="zoom:25%;" />

这种结构**可以用不同的文件名指向同一个文件**，甚至可以指向同一个目录（共享同一目录下的所有内容）。

需要为**每个共享结点设置一个共享计数器**，用于记录此时有多少个地方在共享该节点。用户提出删除结点的请求时，只是删除该用户的FCB、并使**共享计数器减1**，并不会直接删除共享结点。

**只有共享计数器减为0时，才删除结点**。

注意：共享文件不同于复制文件。在**共享文件中，由于各用户指向的是同一个文件，因此只要其中一个用户修改了文件数据，那么所有用户都可以看到文件数据的变化**。

### 7.3.3 索引结点

索引结点是对FCB的改进。在查找各级目录的过程中，只需要用到“文件名”这个信息，只有文件名匹配时，才需要读出文件的其他信息。因此，可以考虑让目录表“瘦身”来提升效率：

<img src="https://images.drshw.tech/images/notes/image-20221104193459141.png" alt="image-20221104193459141" style="zoom:25%;" />

由于检索文件时只需用到文件名，因此可以将除了文件名之外的其他信息放到索引结点中。这样目录项就只需要包含文件名、索引结点指针。

> 检索效率分析：
>
> 假设一个FCB是64B，磁盘块的大小为1KB，则每个盘块中只能存放16个FCB。
>
> + 若一个文件目录中共有640个目录项，则共需要占用`640/16 = 40`个盘块。因此按照某文件名检索该目录，平均需要查询320个目录项，**平均需要启动磁盘20次（每次磁盘I/O读入一块）**。
>
> + 若**使用索引结点机制**，文件名占14B，索引结点指针占2B，则每个盘块可存放64个目录项，那么按文件名检索目录**平均只需要读入`320/64 = 5`个磁盘块**。显然，这**将大大提升文件检索速度**。

当找到文件名对应的目录项时，才需要将索引结点调入内存，索引结点中记录了文件的各种信息，包括文件在外存中的存放位置，根据“存放位置”即可找到文件。

存放**在外存中**的索引结点称为“**磁盘索引结点**”，当索引结点**放入内存**后称为“**内存索引结点**”。

相比之下**内存索引结点中需要添加一些信息**，比如：文件是否被修改、此时有几个进程正在访问该文件等等。