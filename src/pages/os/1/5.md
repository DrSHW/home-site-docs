---
description: Docs intro
layout: ../../../layouts/MainLayout.astro
---

## 1.5 中断和异常

### 1.5.1 中断机制的诞生

早期的计算机，各程序只能串行执行，系统利用率低。为了解决上述问题，人们发明了操作系统（作为计算机的管理者），但要实现多道程序的并发执行，就必须解决用户态程序需要执行特权指令的问题。为了解决这个问题，人们引入了中断机制。

### 1.5.2 中断的概念和作用

中断有一些特点：

+ 当中断发生时，CPU立即进入**核心态**；
+ 当中断发生后，当前运行的进程暂停运行，并由操作系统内核对中断进行处理；
+ 对应不同的中断信号，操作系统会进行不同的处理。

**发生中断**就意味着**需要操作系统介入**，**开展管理工作**。由于操作系统的管理工作（比如进程切换、分配I/O设备等）需要使用特权指令，因此CPU要从用户态转为核心态。**中断**可以使CPU从**用户态切换为核心态**，**使操作系统获得计算机的控制权**。有了中断，才能实现多道程序并发执行。

中断是CPU实现用户态到核心态的**唯一**途径，而核心态到用户态只需执行一条特权指令，将程序状态字PSW 标志位设置为用户态即可。

若用户程序发生中断，即用户程序中可能产生了一个错误状态；此时CPU就会立即切换到核心态，将CPU的使用权限交给操作系统，操作系统内核就负责对中断信号进行处理。

### 1.5.3 中断的分类

中断可以分为**内中断**（**异常**）和外中断（**狭义的中断**）两类：

<img src="https://images.drshw.tech/images/notes/image-20221005155229425.png" alt="image-20221005155229425" style="zoom:53%;" />

补充：中断的另一种分类方式：

<img src="https://images.drshw.tech/images/notes/image-20221005155323210.png" alt="image-20221005155323210" style="zoom:55%;" />

这样，操作系统的运行环境可以理解为：用户通过操作系统运行上层程序，而这个上层程序的运行依赖操作系统的底层管理程序提供服务支持。

当需要管理程序服务时，系统则通过硬件中断机制进入核心态，运行管理程序；另外也可能是程序运行出现异常情况，被动的需要管理程序的服务，这是就通过异常处理来进入核心态。当管理程序运行结束时，用户程序要继续进行，则通过相应保存程序现场推出中断处理程序或异常处理程序，返回断点处继续执行。

### 1.5.4 外中断的处理过程

若CPU在用户态下运行一个程序，CPU会按序依次执行这些指令；

在执行完每个指令后，CPU都会**检测**当前是否有外部中断信号，无中断则执行下一条指令；

如果检测到外部中断信号，则需要**保护**被中断进程的CPU环境（如程序状态字PSW、程序计数器PC、各种通用寄存器）；

根据中断信号的类型**转入**相应的中断处理程序；

恢复原进程的CPU环境并退出中断，返回原进程继续往下执行。

<img src="https://images.drshw.tech/images/notes/image-20221005161019380.png" alt="image-20221005161019380" style="zoom:50%;" />