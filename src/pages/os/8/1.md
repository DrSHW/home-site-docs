---
description: Docs intro
layout: ../../../layouts/MainLayout.astro
---

## 8.1 外存的组织方式

文件在外存中的分配方式可分为**顺序（连续）分配**、**链接分配**和**索引分配**三种：

<img src="https://images.drshw.tech/images/notes/image-20221113202925297.png" alt="image-20221113202925297" style="zoom:50%;" />

### 8.1.1 文件块与磁盘块

类似于内存分页，磁盘中的存储单元也会被分为一个个“块/磁盘块/物理块”：

<img src="https://images.drshw.tech/images/notes/image-20221113203319051.png" alt="image-20221113203319051" style="zoom:50%;" />

**很多操作系统中，磁盘块的大小与内存块、页面的大小相同**（便于内存、外存数据交换）：

<img src="https://images.drshw.tech/images/notes/image-20221113203412223.png" alt="image-20221113203412223" style="zoom:50%;" />

在内存管理中，进程的逻辑地址空间被分为一个一个页面。同样的，在外存管理中，为了方便对文件数据的管理，**文件的逻辑地址空间也被分为了一个一个的文件“块”**：

<img src="https://images.drshw.tech/images/notes/image-20221113203608050.png" alt="image-20221113203608050" style="zoom:50%;" />

于是文件的逻辑地址也可以表示为**`(逻辑块号, 块内地址)`**的形式：

<img src="https://images.drshw.tech/images/notes/image-20221113204249023.png" alt="image-20221113204249023" style="zoom:50%;" />

### 8.1.2 顺序分配方式

也称**连续分配**方式。

**顺序分配**方式要求**每个文件在磁盘上占有一组连续的块**：

<img src="https://images.drshw.tech/images/notes/image-20221113204618613.png" alt="image-20221113204618613" style="zoom:50%;" />

操作系统需要将`(逻辑块号, 块内地址)`转换为`(物理块号, 块内地址)`（只需转换块号就行，块内地址保持不变），以实现物理地址到逻辑地址的映射。需要在文件目录表中存放起始块号和长度（占用几个块）两个字段，用于实现地址转换：

<img src="https://images.drshw.tech/images/notes/image-20221113205000898.png" alt="image-20221113205000898" style="zoom:50%;" />

用户给出要访问的逻辑块号，操作系统找到该[文件对应的目录项（FCB）](https://docs.drshw.tech/os/7/3/#%E6%96%87%E4%BB%B6%E6%8E%A7%E5%88%B6%E5%9D%97)。再通过`物理块号 = 起始块号 + 逻辑块号`即可得到物理块号。当然，还需要检查用户提供的逻辑块号是否合法（`逻辑块号 ≥ 长度` 就不合法）。

**【结论】**：由于可以直接通过逻辑块号推算出物理块号，因此**顺序分配支持顺序访问和直接访问（即随机访问）**。

读取某个磁盘块时，需要移动磁头。访问的两个磁盘块相隔越远，移动磁头所需时间就越长。**【结论】**：**顺序分配的文件在顺序读/写时速度最快**。

若某时刻磁盘状态如下：

<img src="https://images.drshw.tech/images/notes/image-20221113205953232.png" alt="image-20221113205953232" style="zoom:50%;" />

此时文件A要拓展，需要再增加一个磁盘块（总共需要连续的4个磁盘块）。由于采用连续结构，因此文件A占用的磁盘块必须是连续的，因此只能将文件A全部“迁移”到绿色区域：

<img src="https://images.drshw.tech/images/notes/image-20221113210151184.png" alt="image-20221113210151184" style="zoom:50%;" />

**【结论】**：物理上采用**顺序分配的文件不方便拓展**。

若某时刻磁盘状态如下：

<img src="https://images.drshw.tech/images/notes/image-20221113210328090.png" alt="image-20221113210328090" style="zoom:50%;" />

将**出现很多难以利用的磁盘碎片**。**【结论】**：物理上采用**顺序分配，存储空间利用率低**。（可以使用**紧凑**来处理碎片，但是需要耗费很大的时间代价）

总结：

顺序分配方式的**优点**：

+ 支持顺序访问和直接访问（即随机访问）；
+ 顺序分配的文件在顺序访问时速度最快。

**缺点**：

+ 不方便文件拓展；
+ 存储空间利用率低，会产生磁盘碎片。

### 8.1.3 链接分配方式

链接分配方式采取离散分配的方式，可以为文件分配离散的磁盘块。分为**隐式链接**和**显式链接**两种（若未指明是隐式链接还是显式链接，选择隐式链接）。

#### 隐式链接

其组织方式如下：

<img src="https://images.drshw.tech/images/notes/image-20221113210951279.png" alt="image-20221113210951279" style="zoom:50%;" />

逻辑块号到物理块号的转变方式：

用户给出要访问的逻辑块号`i`，操作系统找到该文件对应的目录项（FCB）。从目录项中找到起始块号（即0号块），将0号逻辑块读入内存，由此知道1号逻辑块存放的物理块号，于是读入1号逻辑块，再找到2号逻辑块的存放位置，以此类推。因此，读入`i`号逻辑块，总共需要`i + 1`次磁盘I/O。

**【结论】**：采用**链式分配（隐式链接）**方式的文件，**只支持顺序访问，不支持随机访问**，查找效率低。另外，指向下一个盘块的指针也需要耗费少量的存储空间。

由于磁盘块可以离散分配，若要拓展文件，则可以随意地找一个空闲磁盘块，挂到文件的磁盘块链尾，并修改文件的FCB（修改结束块号）。

**【结论】**：采用隐式链接的**链接分配方式，很方便文件拓展**；另外，所有的空闲磁盘块都可以被利用，**不会有碎片问题，外存利用率高**。

#### 显式链接

显式链接方式会将用于链接文件各物理块的指针显式地存放在**一张表**中。即**文件分配表**（FAT，File Allocation Table）。

假设某个新创建的文件`aaa`的数据依次存放在磁盘块`2 → 5 → 0 → 1`中，其组织方式如下图：

<img src="https://images.drshw.tech/images/notes/image-20221113212533850.png" alt="image-20221113212533850" style="zoom:50%;" />

同理，假设某个新创建的文件`bbb`的数据依次存放在磁盘块`4 → 23 → 3`中，组织方式如下图：

<img src="https://images.drshw.tech/images/notes/image-20221113213119388.png" alt="image-20221113213119388" style="zoom:50%;" />

**注意：一个磁盘仅设置一张FAT。开机时，将FAT读入内存，并常驻内存。**FAT的各个表项在物理上连续存储，且每一个表项长度相同。因此“物理块号”字段可以是隐含的。

逻辑块号到物理块号的转变方式：

用户给出要访问的逻辑块号`i`，操作系统找到该文件对应的目录项（FCB）。从目录项中找到起始块号，若`i > 0`，则查询内存中的文件分配表FAT，往后找到`i`号逻辑块对应的物理块号。**逻辑块号转换成物理块号的过程不需要读磁盘操作**。

**【结论】**：采用**链式分配（显式链接）**方式的文件，支持顺序访问，也**支持随机访问（想访问`i`号物理块时，并不需要依次访问之前的`0 ~ i-1 `号物理块）**，由于块号转换的过程不需要访问磁盘，因此相比于隐式链接来说，访问速度快很多。

显然，显示链接也**不会产生外部碎片，也可以很方便地对文件进行拓展**。

缺点：文件分配表需要占用一定的存储空间。

### 8.1.4 索引分配方式

#### 索引分配方式的原理

**索引分配**允许文件离散地分配在各个磁盘块中，系统会**为每个文件建立一张索引表**，索引表中**记录了文件的各个逻辑块对应的物理块**（索引表的功能类似于内存管理中的页表——建立逻辑页面到物理页面之间的映射关系）。索引表存放的磁盘块称为**索引块**。文件数据存放的磁盘块称为**数据块**。

假设某个新创建的文件`aaa`的数据依次存放在磁盘块`2 → 5 → 13 → 9`中，系统会先构造文件`aaa`的索引表；若7号磁盘块是文件`aaa`的索引块，索引块中保存了索引表的内容：

<img src="https://images.drshw.tech/images/notes/image-20221113215355959.png" alt="image-20221113215355959" style="zoom:50%;" />

注：在显式链接的链式分配方式中，文件分配表FAT是一个磁盘对应一张。而索引分配方式中，索引表是一个文件对应一张。

可以用固定的长度表示物理块号（如：假设磁盘总容量为`1TB = 2^40B`，磁盘块大小为`1KB`，则共有`2^30`个磁盘块，则可用`4B`表示磁盘块号），因此，索引表中的“逻辑块号”是可以隐含的。

逻辑块号到物理块号的转变方式：

用户给出要访问的逻辑块号`i`，操作系统找到该文件对应的目录项（FCB）。从目录项可知索引表存放位置，将索引表从外存读入内存，并查找索引表即可知`i`号逻辑块在外存中的存放位置。

可见，**索引分配方式可以支持随机访问**。**文件拓展也很容易实现**（只需要给文件分配一个空闲块，并增加一个索引表项即可）。

若一个磁盘块1KB，一个索引表项4B，则一个磁盘块只能存放256个索引项。若一个文件的大小超过了256块，那么一个磁盘块时装不下文件的整张索引表的，需要引入：链接方案、多层索引、混合索引三种解决方案。

#### 链接方案

思想：如果索引表太大，一个索引块装不下，那么可以将多个索引块链接起来存放。

假设磁盘块大小为1KB，一个索引表项占4B，则一个磁盘块只能存放256个索引项。若文件`aaa`的索引表需要两个索引块，块号`0~255`位于7号块，块号`256~511`位于15号块，外存组织方式如下：

<img src="https://images.drshw.tech/images/notes/image-20221113220628131.png" alt="image-20221113220628131" style="zoom:50%;" />

由于索引块由链接方式组织，FCB中只需添加第一个索引表对应的索引块的块号即可。

再看一种情况：若一个文件大小为`256*256KB = 65536KB = 64MB`，则该文件共有`256*256`个块，也就对应`256*256`个索引项，也就需要`256`个索引块来存储，这些索引块用链接方式连接起来。若想要访问文件的最后一个逻辑块，就必须找到最后一个索引块（第256个索引块），而各个索引块之间是用指针链接起来的，因此必须先顺序地读入前255个索引块，这显然是很低效的。

#### 索引分配

为处理链接方案在处理大文件时低效的问题，引入了多层索引。

思想：建立多层索引（原理类似于[多级页表](https://docs.drshw.tech/os/4/3/#435-%E4%B8%A4%E7%BA%A7%E9%A1%B5%E8%A1%A8)）。使第一层索引指向第二层的索引块。还可根据文件大小的要求再建立第三层、第四层索引块。

假设磁盘块大小为1KB，一个索引表项占4B，则一个磁盘块只能存放256个索引项，文件`aaa`的第一个索引表对应7号索引块，外存组织方式如下：

<img src="https://images.drshw.tech/images/notes/image-20221113222716957.png" alt="image-20221113222716957" style="zoom:50%;" />

FCB中只需添加顶级索引表对应的索引块的块号即可。

若某文件采用**两层索引**，则该**文件的最大长度**可以达到`256*256*1KB = 64MB`。

可根据逻辑块号算出应该查找索引表中的哪个表项：

+ 如：要访问1026号逻辑块，则：`1026/256 = 4, 1026%256 = 2`，因此可先将一级索引表调入内存，查询4号表项，将其对应的二级索引表调入内存，查询4号表项，将其对应的二级索引表调入内存，再查询二级索引表的2号表项即可知道1026号逻辑块存放的磁盘块号了。（**访问目标数据块，需要三次磁盘I/O**）

若采用三层索引，则该**文件的最大长度**为：`256*256*256*1KB = 16GB`。类似的，**访问目标数据块，需要4次磁盘I/O**。

**【结论】**：采用K层索引结构，且**顶级索引表未调入内存**，则访问一个数据块只需要`K + 1`次读磁盘操作。

问题：若一个文件仅有1KB，而在采用两层索引结构的情况下，读取该1KB的内容依旧需要3次磁盘I/O操作，效率较低。

#### 混合索引

思想：结合了多种索引分配方式。例如：一个文件的顶级索引表中，既包含**直接地址索引**（直接指向数据块），又包含**一级间接索引**（指向单层索引表）、还包含**两级间接索引**（指向两层索引表）：

若混合索引中包括8个直接地址，1个一级间接地址，1个二级间接地址，其外存组织方式如下： 

<img src="https://images.drshw.tech/images/notes/image-20221113224057255.png" alt="image-20221113224057255" style="zoom:50%;" />

以上结构中，索引支持的最大文件长度为65800KB。

若顶级索引表未读入内存：

+ 访问`0~7`号逻辑块需要2次磁盘I/O；
+ 访问`8~263`号逻辑块需要3次磁盘I/O；
+ 访问`264~65799`号逻辑块需要4次磁盘I/O；

此时，对小文件而言，只需较少的读磁盘次数即可访问目标数据块（一般计算机中小文件更多）。

总结：

<img src="https://images.drshw.tech/images/notes/image-20221113224747721.png" alt="image-20221113224747721" style="zoom:50%;" />
