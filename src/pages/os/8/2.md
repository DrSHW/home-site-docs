---
description: Docs intro
layout: ../../../layouts/MainLayout.astro
---

## 8.2 文件存储空间的管理

<img src="https://images.drshw.tech/images/notes/image-20221114180608760.png" alt="image-20221114180608760" style="zoom:50%;" />

### 8.2.1 存储空间的划分与初始化

存储空间的划分：将物理磁盘划分为一个个文件卷（逻辑卷、逻辑盘）。例如，在安装Windows操作系统时，需要磁盘分区（分出C、D、E盘）。

每个文件卷需要划分出目录区和文件区：

<img src="https://images.drshw.tech/images/notes/image-20221114181156540.png" alt="image-20221114181156540" style="zoom:50%;" />

在一些支持超大型文件的系统中，可支持由多个物理磁盘组成一个文件卷：

<img src="https://images.drshw.tech/images/notes/image-20221114195331292.png" alt="image-20221114195331292" style="zoom:50%;" />

文件存储空间的管理方法有以下几种：

<img src="https://images.drshw.tech/images/notes/image-20221114195504132.png" alt="image-20221114195504132" style="zoom:50%;" />

### 8.2.2 空闲表法

分配磁盘块的方式：

+ 与内存管理中的[动态分区分配](https://docs.drshw.tech/os/4/2/#424-%E5%8A%A8%E6%80%81%E5%88%86%E5%8C%BA%E5%88%86%E9%85%8D%E7%AE%97%E6%B3%95)很类似，为文件**分配连续的存储空间**。同样**可采用首次适应、最佳适应、最坏适应**等算法来决定要为文件分配那个区间。

示例：若新创建的文件请求3个块，采用首次适应算法，初始空闲盘块表如下：

<img src="https://images.drshw.tech/images/notes/image-20221114200529183.png" alt="image-20221114200529183" style="zoom:50%;" />

分配后的空闲盘块表如下：

<img src="https://images.drshw.tech/images/notes/image-20221114200211569.png" alt="image-20221114200211569" style="zoom:50%;" />

回收磁盘块的方式：

+ 与内存管理中的动态分区分配很类似，当回收某个存储区时需要有四种情况：

  1. 回收区的前后都没有相邻空闲区（新增表项）；
  2. 回收区的前后都是空闲区（将其与前后两个空闲区合并）；
  3. 回收区前面是空闲区（与前空闲区合并）；
  4. 回收区后面是空闲区（与后空闲区合并）

  **总之，回收时需要注意表项的合并问题**。

示例：假设此时删除了某文件，系统回收了它占用15、16、17号块，初始磁盘和空闲盘块表如下：

<img src="https://images.drshw.tech/images/notes/image-20221114201040274.png" alt="image-20221114201040274" style="zoom:50%;" /><img src="https://images.drshw.tech/images/notes/image-20221114200234593.png" alt="image-20221114200211569" style="zoom:50%;" />

回收磁盘块后，该状态变为”

<img src="https://images.drshw.tech/images/notes/image-20221114201232579.png" alt="image-20221114201232579" style="zoom:50%;" /><img src="https://images.drshw.tech/images/notes/image-20221114201302980.png" alt="image-20221114201302980" style="zoom:50%;" />

### 8.2.3 空闲链表法

可进一步划分为空闲盘块链和空闲盘区链：

+ 空闲盘块链：以盘块为单位组成一条空闲链：

  <img src="https://images.drshw.tech/images/notes/image-20221114202729632.png" alt="image-20221114202729632" style="zoom:50%;" />

+ 空闲盘区链：以盘区为单位组成的一条空闲链：

  <img src="https://images.drshw.tech/images/notes/image-20221114203059376.png" alt="image-20221114203059376" style="zoom:50%;" />

对于空闲盘块链，操作系统将保存**链头、链尾指针**。

分配磁盘块的方式：

+ 若某文件申请`K`个盘块，则从链头开始依次摘下`K`个盘块分配，并修改空闲链的头指针。

回收磁盘块的方式：

+ 回收的盘块依次挂到链尾，并修改空闲链的链尾指针。

这种管理方法适用于离散分配的物理结构。为文件分配多个盘块时可能要重复多次操作

对于空闲盘区链，操作系统也会保存**链头、链尾指针**。

分配磁盘块的方式：

+ 若某文件申请`K`个盘块，则可以采用首次适应、最佳适应等算法，从链头开始检索，按照算法规则找到一个大小符合要求的空闲盘区，分配给文件。若没有合适的连续空闲块，也可以将不同盘区的盘块同时分配给一个文件，注意分配后可能要修改相应的链指针、盘区大小等数据。

回收磁盘块的方式：

+ 若回收区和某个空闲盘区相邻，则需要将回收区合并到空闲盘区中。若回收区没有和任何空闲区相邻，将回收区作为单独的一个空闲区挂到链尾。

这种管理方法对于离散分配和连续分配都适用。为一个文件分配多个盘块时效率更高。

### 8.2.4 位示图法

思想：每个二进制位对应一个盘块，例如：

<img src="https://images.drshw.tech/images/notes/image-20221114204157137.png" alt="image-20221114204157137" style="zoom:50%;" />

在上方的例子中，“0”代表盘块空闲，“1”代表盘块已分配。位示图一般用连续的“字”来表示，上方例子中一个字的字长是16位，字中的每一位对应一个盘块。因此**可以用`(字号, 位号)`对应一个盘块号**。当然有些题目中也描述为`(行号, 列号)`，***<u>要能自己推出盘块号与`(字号, 位号)`相互转换的公式</u>***（**注意题目条件：盘块号、字号、位号**到底是从0开始还是从1开始）。

如上方例子中的**盘块号、字号、位号从0开始**，若`n`表示字长，则`(字号, 位号) = (i, j)`的二进制位对应的**盘块号`b = ni + j`**；`b`号盘块对应的**字号`i = b/n`**，**位号`j = b%n`**。

分配磁盘块的方式：

+ 若文件需要`K`个块：
  1. 顺序扫描位示图，找到`K`个相邻或不相邻的“0”；
  2. 根据字号、位号算出对应的盘块号，将相应盘块分配给文件；
  3. 将相应位设置为“1”。

回收磁盘块的方式：

1. 根据回收的盘块号计算出对应的字号、位号；
2. 将相应二进制位设为“0”。

这种管理方法对于离散分配和连续分配都适用。

### 8.2.5 成组链接法

空闲表法、空闲链表法不适用于大型文件系统，因为空闲表或空闲链表可能过大。UNIX中采用了**成组链接法**对磁盘空闲块进行管理。

该方法中，**文件卷的目录区**中专门用一个磁盘作为“**超级块**”，当系统启动时需要将**超级块读入内存**。并且要保证内存与外存中的“超级块”数据一致：

<img src="https://images.drshw.tech/images/notes/image-20221114205457302.png" alt="image-20221114205457302" style="zoom:50%;" />

超级块中记录了下一组空闲盘块的数量和对应的盘块号；通过这些盘块号即可找到下一分组的各个盘块；直到超级块中的第一个值为某特殊值（如 -1）：

<img src="https://images.drshw.tech/images/notes/image-20221114205818682.png" alt="image-20221114205818682" style="zoom:50%;" />

每一个分组的盘块数量有上限（上方示例中每个分组有100个盘块），最后一个分组的盘块数要少一个（由于最后的超级块中，某字段被设置为特殊值）。

分配磁盘块的方式：

+ 若需要1个空闲块：

  1. 检查第一个分组的块数是否足够。`1 < 100`，因此是足够的；

  2. 分配第一个分组中的第1个空闲块，并修改相应数据：

     <img src="https://images.drshw.tech/images/notes/image-20221114210650727.png" alt="image-20221114210630044" style="zoom:50%;" />→<img src="https://images.drshw.tech/images/notes/image-20221114210630044.png" alt="image-20221114210630044" style="zoom:50%;" />

+ 若需要100个空闲块：

  1. 检查第一个分组的块数是够足够。`100 = 100`，是足够的；

  2. 分配第一个分组中的100个空闲块。但是**由于300号块内存放了再下一组的信息，因此300号块的数据需要复制到超级块中**。

     <img src="https://images.drshw.tech/images/notes/image-20221114211228115.png" alt="image-20221114211228115" style="zoom:40%;" />→<img src="https://images.drshw.tech/images/notes/image-20221114211325758.png" alt="image-20221114211325758" style="zoom:40%;" />

     （超级块充当了一个链头的角色，永远要保持指向下一个分组的信息。）

回收磁盘块的方式：

+ 若每个分组最多有100个空闲块，此时第一个分组已有99个块，还要再回收一块：

  <img src="https://images.drshw.tech/images/notes/image-20221114210630044.png" alt="image-20221114210630044" style="zoom:50%;" />→<img src="https://images.drshw.tech/images/notes/image-20221114210650727.png" alt="image-20221114210630044" style="zoom:50%;" />

+ 若每个分组最多有100个空闲块，此时第一个分组已有100个块，还要再回收一块：

  需要将超级块中的数据复制到新回收的块中，并修改超级块成为第一个分组：

  <img src="https://images.drshw.tech/images/notes/image-20221114212105873.png" alt="image-20221114212105873" style="zoom:40%;" />→<img src="https://images.drshw.tech/images/notes/image-20221114212245959.png" alt="image-20221114212245959" style="zoom:40%;" />
