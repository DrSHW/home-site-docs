---
description: 组成原理
layout: ../../../layouts/MainLayout.astro
---

## 3.3 主存储器与CPU之间的连接

### 3.3.1 存储器与CPU之间的连接

<img src="https://images.drshw.tech/images/notes/image-20230316213454639.png" alt="image-20230316213454639" style="zoom:50%;" />

#### 统一命名格式

在理解连接方式之前，需要先统一存储芯片的输入输出信号命名：

+ 使用`A0 ~ An-1`表示（地址线）输入的多位地址；
+ 使用`D0 ~ Dn-1`表示（数据线）输出的数据；
+ 使用<img src="https://images.drshw.tech/images/notes/image-20230315143035229.png" alt="image-20230315143035229" style="zoom:50%;" />表示输入的片选信号；
+ 使用<img src="https://images.drshw.tech/images/notes/image-20230316190928907.png" alt="image-20230316190928907" style="zoom:50%;" />表示输入的读写信号。

例如，一块8K * 8bit的存储芯片：

<img src="https://images.drshw.tech/images/notes/image-20230316191031531.png" alt="image-20230316191031531" style="zoom:50%;" />

#### 存储芯片的位扩展

所谓位扩展，即**扩展存储芯片字长**。

若一个CPU有16条地址线，8条数据线，

若现有两块8K * 1bit的存储芯片，需要扩展为8K * 2bit的存储器，可按照下图的方式将其与CPU连接：

<img src="https://images.drshw.tech/images/notes/image-20230316192714427.png" alt="image-20230316192714427" style="zoom:50%;" />

说明：

1. 首先，由于总共有`8K = 2^13`个存储单元，故需要使用13根地址线（A0 ~ A12），两存储芯片的地址线与CPU对应地址线连接；
2. 由于每块存储芯片字长1bit，故每块芯片通过数据总线，与CPU的一个不同数据线接口连接；
3. 片选信号置为1，芯片正常工作；
4. 两块芯片需要同时读写，故读写控制线均连接CPU读写信号。

于是，8块8K * 1bit的存储芯片也可以按下图方式，扩展为8K * 8bit的存储器：

<img src="https://images.drshw.tech/images/notes/image-20230316192930953.png" alt="image-20230316192930953" style="zoom:50%;" />

#### 存储芯片的字扩展

所谓字扩展，即**扩展主存字数**。

若现有两块8K * 8bit的存储芯片，需要扩展为16K * 2bit的存储器，若按照**线选法**与CPU（参数同上）连接，如下图：

<img src="https://images.drshw.tech/images/notes/image-20230316204520801.png" alt="image-20230316204520801" style="zoom:50%;" />

说明：

1. 存储芯片字长等于CPU数据线接口数，直接与CPU对应连接即可；
2. 由于有两块芯片，需要轮流进行工作，这里CPU使用两根空闲地址线A13、A14分别与两块芯片连接：
   + 当A13为1，A14为0时，选中左边的芯片；当A13为0，A14为1时，选中右边的芯片；

> 由于系统启动时每时刻只会有1块芯片在工作，因此若A13A14出现00或11的情况，将会产生异常。
>
> 左芯片最低地址：`010 0000 0000 0000`；最高地址：`011 1111 1111 1111`。
>
> 右芯片最低地址：`100 0000 0000 0000`；最高地址：`101 1111 1111 1111`。

若采用译码片选法连接，如下图：

<img src="https://images.drshw.tech/images/notes/image-20230316202540668.png" alt="image-20230316202540668" style="zoom:50%;" />

说明：

1. 数据线连接方式同线选法；
2. 使用CPU的一根地址线A13，将两芯片并联，在其中一条并联电路中连接一个二极管电路（非门），此时：
   + 当A13为1时，右边芯片导通；当A13为0时，左边芯片导通。

> 非门也可以看成是一个1-2译码器。
>
> 片选法确保了启动时每时刻同时只会选择一块芯片，也节约了地址线，代价是增加了一个译码电路。
>
> 左芯片最低地址：`10 0000 0000 0000`；最高地址：`11 1111 1111 1111`。
>
> 右芯片最低地址：`00 0000 0000 0000`；最高地址：`01 1111 1111 1111`。

同样地，若要使用4块8K * 8bit规格的存储芯片，组成一个32K * 8bit规格的存储器，连接方式如下图：

<img src="https://images.drshw.tech/images/notes/image-20230316212658712.png" alt="image-20230316212658712" style="zoom:50%;" />

使用了一个2-4译码器替换了原先的非门并联电路。

对比线选法和译码片选法：

<img src="https://images.drshw.tech/images/notes/image-20230316212847694.png" alt="image-20230316212847694" style="zoom:50%;" />

#### 字位同时扩展

看一个案例，下图中使用8片16K * 4bit的存储器，组成一个64K* 8bit的存储器：

<img src="https://images.drshw.tech/images/notes/image-20230316213040668.png" alt="image-20230316213040668" style="zoom:50%;" />

+ 使用位扩展，每两块芯片数据线分别与CPU的前4位和后4位连接，组成一个16K * 8位的存储器；
+ 在使用2-4译码器，两块芯片看成一组，进行字扩展；
+ 各芯片地址表示范围见上图。

#### 聊聊译码器

一般的译码器除了有数据输入、输出接口，还会有使能端接口，仅当该接口有效时，译码器才会工作；

+ 单个使能信号，可由符号EN表示：

  <img src="https://images.drshw.tech/images/notes/image-20230317194835930.png" alt="image-20230317194835930" style="zoom:50%;" />

+ 多个使能信号，可由GA、G2A、G2B来表示，例如，74LS138芯片：

<img src="https://images.drshw.tech/images/notes/image-20230317195035282.png" alt="image-20230317195035282" style="zoom:50%;" />

一般CPU还会有MREQ（主存储器请求）接口，当CPU访问主存时，会使该信号有效，一般与译码器使能信号连接：

<img src="https://images.drshw.tech/images/notes/image-20230317195429655.png" alt="image-20230317195429655" style="zoom: 50%;" />

#### RAM的读周期

RAM读周期的时序图如下：

<img src="https://images.drshw.tech/images/notes/image-20230317195653660.png" alt="image-20230317195653660" style="zoom: 67%;" />

+ 第一行表示CPU送出的地址信号；

+ 第二行表示片选信号CS的有效时间；

  > CPU发出主存储器请求信号，使译码器开始工作，并产生片选信号CS。
  >
  > 
  >
  > 为何地址变化后要等一小段时间，CS才变为有效？
  >
  > + 需要等待表示地址的电信号**稳定**后，才能开始读取数据信息。

+ 第三行Dout表示数据总线传出数据；

  > 数据传出后，等待一小段时间，CPU即可撤销请求信号，此时CS变为无效状态。

### 3.3.2 双端口RAM与多模块存储器

<img src="https://images.drshw.tech/images/notes/image-20230317205232534.png" alt="image-20230317205232534" style="zoom:50%;" />

#### 双端口RAM

即具有两个端口的RAM：

<img src="../../../../../../AppData/Roaming/Typora/typora-user-images/image-20230317200722619.png" alt="image-20230317200722619" style="zoom:50%;" />

> 双端口RAM需要有两组完全独立的数据线、地址线、控制线。CPU、RAM中也要有更复杂的控制电路。

作用：优化多核CPU访问一根内存条的速度。

两个端口对同一主存操作有以下4种情况：

1. 两个端口同时对不同的地址单元存取数据，无冲突；
2. 两个端口同时对同一地址单元读出数据，无冲突；
3. 两个端口同时对同一地址单元写入数据，存在冲突，将导致**写入错误**；
4. 两个端口同时对同一地址单元，一个写入数据，另一个读出数据，存在冲突，将导致**读出错误**。

> 解决方法：
> 置“忙”信号为0，由判断逻辑决定暂时关闭一个端口（即被延时），未被关闭的端口正常访问，被关闭的端口延长一个很短的时间段后再访问。
>
> 类似于操作系统章节的[读者-写者问题](https://docs.drshw.tech/os/2/4/#244-%E8%AF%BB%E8%80%85-%E5%86%99%E8%80%85%E9%97%AE%E9%A2%98)。

#### 多体并行存储器

高位交叉编址：即采用**高比特位**来**区分**访问的是哪个**存储体**。低位交叉编址即采用低位区分。

<img src="https://images.drshw.tech/images/notes/image-20230317202045744.png" alt="image-20230317202045744" style="zoom:50%;" />

例如有4个存储体，5位地址，分别采用高低位交叉编址结果如下：

<img src="https://images.drshw.tech/images/notes/image-20230317202347700.png" alt="image-20230317202347700" style="zoom:50%;" />

假设存储体存取周期为`T`，存取时间为`r`，若连续访问内存地址：`00000`、`00001`、`00010`、`00011`、`00100`：

+ 若采用高位交叉编址：

  则读取的均为M0存储体中的内容，每读1次都需要等待存储器恢复时间（读取的是同一块存储体）。

  甘特图如下：

  <img src="https://images.drshw.tech/images/notes/image-20230317202813969.png" alt="image-20230317202813969" style="zoom:50%;" />

+ 若采用低位交叉编址：

  则读取的分别为M0、M1、M2、M3、M0存储体中的内容，当读取完M0时，直接读取M1即可，CPU无需等待（存储器恢复是自行完成的工作，与CPU无关）。同理，直接读取M2、M3，再次读取M0时，已经恢复完毕，因此直接读即可。

  甘特图如下：

  <img src="https://images.drshw.tech/images/notes/image-20230317203418955.png" alt="image-20230317203418955" style="zoom:50%;" />

> 由于程序一般是顺序执行的，故一般会探讨连续访问的情况。

低位交叉编址的方式，也体现了**采用“流水线”的方式**并行存取（宏观上并行，微观上串行）的思想。

即，宏观上，一个存储周期内，`m`体交叉存储器可以提供的数据量为单个模块的`m`倍。

存取周期为`T`，**存取时间为`r`**，为了使流水线不间断，应保证**模块数`m >= T/r`**。

> 若`m < T/r`，还是使用上方的例子，若只有3个存储体，读取存储体的变为M0、M1、M2、M0，则读取完M2后，M0并未恢复完毕，CPU需要等待额外的时间`r`，造成空转。
>
> 一般来说，`m = T/r`的情况可以让各个硬件性能都发挥到极致。这里的存取时间也可以被替换为**总线传输周期**。

因此，多体并行存储器的特点可总结为：

+ 每个模块都有相同的容量和存取速度。
+ 各模块都有独立的读写控制电路、地址寄存器和数据寄存器它们既能并行工作，又能交叉工作。

传统的单体多字存储器：

+ 每个存储单元存储`m`个字；
+ 总线宽度也为`m`个字；
+ 一次并行读出`m`个字。

<img src="https://images.drshw.tech/images/notes/image-20230317205026180.png" alt="image-20230317205026180" style="zoom:50%;" />

与多体并行存储器比，单体多字存储器不能单独读取其中某个字，指令和数据在主存内必须连续存放，灵活性较差。
